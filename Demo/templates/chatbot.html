<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TribalLink - AgriHelp Bot</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.0/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link rel="stylesheet" href="{{ url_for('static', filename='styles.css') }}">
</head>
<body>
    <!-- Navigation -->
    <nav class="navbar navbar-expand-lg navbar-dark sticky-top" style="background: linear-gradient(135deg, #4CAF50 0%, #45a049 100%); box-shadow: 0 2px 10px rgba(0,0,0,0.1);">
        <div class="container-fluid px-4">
            <a class="navbar-brand fw-bold" href="/" style="font-size: 1.5em;"><i class="fas fa-leaf"></i> TribalLink</a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav"><span class="navbar-toggler-icon"></span></button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav ms-auto">
                    <li class="nav-item"><a class="nav-link" href="/">üè† Home</a></li>
                    <li class="nav-item"><a class="nav-link" href="/marketplace">üõçÔ∏è Marketplace</a></li>
                    <li class="nav-item"><a class="nav-link active" href="/chatbot">ü§ñ AgriHelp Bot</a></li>
                    <li class="nav-item"><a class="nav-link" href="/about">‚ÑπÔ∏è About</a></li>
                    <li class="nav-item"><a class="nav-link" href="/contact">üìß Contact</a></li>
                    <li class="nav-item"><a class="nav-link" href="/cart"><i class="fas fa-shopping-cart"></i> Cart <span class="badge bg-danger" id="cart-count">0</span></a></li>
                </ul>
            </div>
        </div>
    </nav>

    <!-- Hero -->
    <section style="background: linear-gradient(135deg, #4CAF50 0%, #45a049 100%); color: white; padding: 40px 20px; text-align: center;">
        <h1 class="display-5 fw-bold">üåæ AgriHelp Bot</h1>
        <p class="lead">Your AI Assistant for Tribal Farming & Products</p>
        <!-- Language Selector -->
        <div style="margin-top: 20px;">
            <p class="mb-2" style="font-size: 0.9em;">üåê Choose Language / ‡§≠‡§æ‡§∑‡§æ ‡§ö‡•Å‡§®‡•á‡§Ç:</p>
            <div style="display: flex; gap: 8px; justify-content: center; flex-wrap: wrap;">
                <button class="lang-btn" data-lang="en" style="padding: 6px 14px; background: white; color: #4CAF50; border: none; border-radius: 20px; cursor: pointer; font-weight: 600; transition: all 0.3s;">English</button>
                <button class="lang-btn" data-lang="hi" style="padding: 6px 14px; background: rgba(255,255,255,0.3); color: white; border: 1px solid white; border-radius: 20px; cursor: pointer; font-weight: 600; transition: all 0.3s;">‡§π‡§ø‡§Ç‡§¶‡•Ä</button>
                <button class="lang-btn" data-lang="san" style="padding: 6px 14px; background: rgba(255,255,255,0.3); color: white; border: 1px solid white; border-radius: 20px; cursor: pointer; font-weight: 600; transition: all 0.3s;">‡§∏‡§Ç‡§•‡§æ‡§≤‡•Ä</button>
                <button class="lang-btn" data-lang="mun" style="padding: 6px 14px; background: rgba(255,255,255,0.3); color: white; border: 1px solid white; border-radius: 20px; cursor: pointer; font-weight: 600; transition: all 0.3s;">Mundari</button>
                <button class="lang-btn" data-lang="ho" style="padding: 6px 14px; background: rgba(255,255,255,0.3); color: white; border: 1px solid white; border-radius: 20px; cursor: pointer; font-weight: 600; transition: all 0.3s;">Ho</button>
            </div>
        </div>
    </section>

    <div class="container my-5">
        <div class="row">
            <!-- Chatbot -->
            <div class="col-lg-8 mx-auto">
                <div class="card shadow-lg" style="border-top: 4px solid #4CAF50; min-height: 600px; display: flex; flex-direction: column;">
                    <!-- Chat Header -->
                    <div class="card-header" style="background: linear-gradient(135deg, #4CAF50 0%, #45a049 100%); color: white;">
                        <div class="d-flex align-items-center">
                            <i class="fas fa-robot" style="font-size: 1.5em; margin-right: 10px;"></i>
                            <div>
                                <h6 class="mb-0 fw-bold">AgriHelp Bot</h6>
                                <small style="opacity: 0.9;">Online ‚Ä¢ Ready to help</small>
                            </div>
                        </div>
                    </div>

                    <!-- Chat Box -->
                    <div class="card-body" id="chat-box" style="flex: 1; overflow-y: auto; background: #f8f9fa; display: flex; flex-direction: column;">
                        <div style="margin-bottom: auto;">
                            <div class="mb-3">
                                <div style="background: white; padding: 12px 15px; border-radius: 15px; max-width: 80%; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
                                    <p class="mb-0"><strong style="color: #4CAF50;">AgriHelp Bot</strong></p>
                                    <p class="mb-0 mt-2">üëã Welcome! I'm AgriHelp Bot, your AI assistant for tribal farming and marketplace support.</p>
                                    <p class="mb-0 mt-2 small text-muted">I can help with:</p>
                                    <p class="mb-0 small text-muted">
                                        üåæ Farming techniques ‚Ä¢ üõçÔ∏è Product info ‚Ä¢ üìã Government schemes ‚Ä¢ üìö Skill development<br>
                                        Try: "How to grow rice?" or "Tell me about products"
                                    </p>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Chat Footer -->
                    <div class="card-footer" style="background: white; border-top: 1px solid #ddd;">
                        <form onsubmit="event.preventDefault(); sendMessage();" class="d-flex gap-2">
                            <input 
                                type="text" 
                                id="user-input" 
                                class="form-control" 
                                placeholder="Type your question..."
                                autocomplete="off"
                                style="border-radius: 20px; border: 2px solid #ddd; padding: 10px 15px; transition: border-color 0.3s;"
                            >
                            <button type="submit" class="btn btn-success fw-bold" style="border-radius: 20px; padding: 8px 25px;">
                                <i class="fas fa-paper-plane"></i> Send
                            </button>
                        </form>
                    </div>
                </div>

                <!-- Info Box -->
                <div class="mt-4 alert alert-info" style="border-left: 4px solid #4CAF50; background: #f0f8f5;">
                    <p class="mb-0">
                        <i class="fas fa-lightbulb"></i> <strong>Try asking about:</strong><br>
                        "How do I grow bamboo?" ‚Ä¢ "What schemes exist for farmers?" ‚Ä¢ "Tell me about marketplace products" ‚Ä¢ "How is payment done?"
                    </p>
                </div>
            </div>
        </div>
    </div>

    <!-- Footer -->
    <footer class="bg-dark text-white py-5">
        <div class="container text-center text-muted">
            <p>&copy; 2025 TribalLink. All rights reserved. | Team TechTribe - Pemiya Rishikesh Institute of Technology</p>
        </div>
    </footer>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.0/js/bootstrap.bundle.min.js"></script>
    <script src="{{ url_for('static', filename='app.js') }}"></script>
    <script>
        let currentLanguage = 'en';

        // Language button handling
        document.querySelectorAll('.lang-btn').forEach(btn => {
            btn.addEventListener('click', function() {
                currentLanguage = this.getAttribute('data-lang');
                
                // Update button styles
                document.querySelectorAll('.lang-btn').forEach(b => {
                    b.style.background = 'rgba(255,255,255,0.3)';
                    b.style.color = 'white';
                    b.style.border = '1px solid white';
                });
                this.style.background = 'white';
                this.style.color = '#4CAF50';
                this.style.border = 'none';
                
                // Clear chat and show language welcome
                document.getElementById('chat-box').innerHTML = `
                    <div style="margin-bottom: 15px;">
                        <div style="background: white; padding: 12px 15px; border-radius: 15px; max-width: 80%; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
                            <p class="mb-0"><strong style="color: #4CAF50;">AgriHelp Bot</strong></p>
                            <p class="mb-0 mt-2">
                                ${currentLanguage === 'en' ? 'üëã Language changed to English!' : ''}
                                ${currentLanguage === 'hi' ? 'üëã ‡§≠‡§æ‡§∑‡§æ ‡§π‡§ø‡§Ç‡§¶‡•Ä ‡§Æ‡•á‡§Ç ‡§¨‡§¶‡§≤ ‡§ó‡§à ‡§π‡•à!' : ''}
                                ${currentLanguage === 'san' ? 'üëã ‡§≠‡§æ‡§∑‡§æ ‡§∏‡§Ç‡§•‡§æ‡§≤‡•Ä ‡§Æ‡•á‡§Ç ‡§¨‡§¶‡§≤ ‡§ó‡§à ‡§π‡•à!' : ''}
                                ${currentLanguage === 'mun' ? 'üëã ‡§≠‡§æ‡§∑‡§æ Mundari ‡§Æ‡•á‡§Ç ‡§¨‡§¶‡§≤ ‡§ó‡§à ‡§π‡•à!' : ''}
                                ${currentLanguage === 'ho' ? 'üëã Language changed to Ho!' : ''}
                            </p>
                        </div>
                    </div>
                `;
                
                // Store in session
                sessionStorage.setItem('chatLanguage', currentLanguage);
            });
        });

        // Load saved language on page load
        window.addEventListener('load', function() {
            const savedLang = sessionStorage.getItem('chatLanguage') || 'en';
            currentLanguage = savedLang;
            const langBtn = document.querySelector(`[data-lang="${savedLang}"]`);
            if (langBtn) {
                langBtn.click();
            }
        });

        function sendMessage() {
            var userInput = document.getElementById("user-input");
            var message = userInput.value.trim();
            
            if (message === "") {
                alert("Please type a message!");
                return;
            }

            var chatBox = document.getElementById("chat-box");

            // Display user message
            var userMsg = document.createElement("div");
            userMsg.style.marginBottom = "15px";
            userMsg.style.display = "flex";
            userMsg.style.justifyContent = "flex-end";
            userMsg.innerHTML = `<div style="background: #4CAF50; color: white; padding: 12px 15px; border-radius: 15px; max-width: 80%; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
                                    <p class="mb-0">${escapeHtml(message)}</p>
                                </div>`;
            chatBox.appendChild(userMsg);

            // Show loading indicator
            var loadingMsg = document.createElement("div");
            loadingMsg.innerHTML = `<div style="background: white; padding: 12px 15px; border-radius: 15px; max-width: 80%; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
                                        <p class="mb-0"><strong style="color: #4CAF50;">AgriHelp Bot</strong></p>
                                        <p class="mb-0 mt-2"><em>${currentLanguage === 'en' ? 'Typing...' : currentLanguage === 'hi' ? '‡§ü‡§æ‡§á‡§™ ‡§ï‡§∞ ‡§∞‡§π‡•á ‡§π‡•à‡§Ç...' : 'Typing...'}</em></p>
                                    </div>`;
            loadingMsg.id = "loading-msg";
            loadingMsg.style.marginBottom = "15px";
            chatBox.appendChild(loadingMsg);
            chatBox.scrollTop = chatBox.scrollHeight;

            // Send to backend API with language info
            fetch('/api/chat', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ message: message, language: currentLanguage })
            })
            .then(response => response.json())
            .then(data => {
                var loading = document.getElementById("loading-msg");
                if (loading) loading.remove();

                if (data.success) {
                    var botMsg = document.createElement("div");
                    botMsg.style.marginBottom = "15px";
                    botMsg.innerHTML = `<div style="background: white; padding: 12px 15px; border-radius: 15px; max-width: 80%; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
                                            <p class="mb-0"><strong style="color: #4CAF50;">AgriHelp Bot</strong></p>
                                            <p class="mb-0 mt-2">${data.response.replace(/\n/g, '<br>')}</p>
                                        </div>`;
                    chatBox.appendChild(botMsg);
                } else {
                    var errorMsg = document.createElement("div");
                    errorMsg.style.marginBottom = "15px";
                    errorMsg.innerHTML = `<div style="background: #f8d7da; padding: 12px 15px; border-radius: 15px; color: #721c24;">
                                            <p class="mb-0"><strong>Error:</strong> Sorry, something went wrong. Please try again.</p>
                                        </div>`;
                    chatBox.appendChild(errorMsg);
                }
                chatBox.scrollTop = chatBox.scrollHeight;
            })
            .catch(error => {
                console.error("Error:", error);
                var loading = document.getElementById("loading-msg");
                if (loading) loading.remove();
                var errorMsg = document.createElement("div");
                errorMsg.style.marginBottom = "15px";
                errorMsg.innerHTML = `<div style="background: #f8d7da; padding: 12px 15px; border-radius: 15px; color: #721c24;">
                                        <p class="mb-0"><strong>Connection Error:</strong> Please check your internet connection.</p>
                                    </div>`;
                chatBox.appendChild(errorMsg);
            });

            userInput.value = "";
            userInput.focus();
        }

        document.addEventListener('DOMContentLoaded', function() {
            var userInput = document.getElementById("user-input");
            if (userInput) {
                userInput.addEventListener('keypress', function(event) {
                    if (event.key === 'Enter') {
                        sendMessage();
                    }
                });
            }
        });

        function escapeHtml(text) {
            var map = {
                '&': '&amp;',
                '<': '&lt;',
                '>': '&gt;',
                '"': '&quot;',
                "'": '&#039;'
            };
            return text.replace(/[&<>"']/g, function(m) { return map[m]; });
        }

        updateCartCount();
    </script>
</body>
</html>
